trigger:
  - main

variables:
  vmImageName: 'ubuntu-latest'
  containerRegistry: 'containerRegistryConnection'
  imageRepository: 'weatherapi'
  tag: $(Build.BuildId)
  resourceGroupName: 'bluegreen-poc-rg'
  appName: 'velidacontainerapp'

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: '$(containerRegistry)'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '**/Dockerfile'
              tags: |
                $(tag)
          
          - task: AzureWebAppContainer@1
            displayName: 'Azure Web App on Container Deploy'
            inputs:
              azureSubscription: $(azureSubscription)
              appName: $(appName)
              containers: $(containerRegistry)/$(imageRepository):$(tag)
              deployToSlotOrASE: true
              resourceGroupName: $(resourceGroupName)
              slotName: blue

          - task: ManualValidation@0
            displayName: 'Manual Validation Before Switch to Green'
            inputs:
              notifyUsers: |
                willvelida@hotmail.co.uk
                willvelida@microsoft.com
              instructions: 'Please validate before switching to Green'
              onTimeout: 'reject'

          - task: AzureAppServiceManage@0
            inputs:
              azureSubscription: $(azureSubscription)
              WebAppName: $(appName)
              ResourceGroupName: $(resourceGroupName)
              SourceSlot: blue
              SwapWithProduction: true